name: CI/CD

on:
    push:
        branches: [main]

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Login to Docker Hub
              run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and push Docker image
              env:
                  IMAGE_NAME: online-courses-api # Thay bằng tên image Docker của bạn
              run: |
                  docker build -t ${{ secrets.DOCKER_USERNAME }}/$IMAGE_NAME:${{ github.sha }} .
                  docker push ${{ secrets.DOCKER_USERNAME }}/$IMAGE_NAME:${{ github.sha }}

            - name: Deploy to EC2 instance
              env:
                  IMAGE_NAME: online-courses-api # Thay bằng tên image Docker của bạn
                  EC2_HOST: ${{ secrets.EC2_HOST }}
                  EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
              run: |
                  ssh -o StrictHostKeyChecking=no $EC2_USERNAME@$EC2_HOST << EOF
                    docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/$IMAGE_NAME:${{ github.sha }}
                    docker stop $(docker ps -a -q)
                    docker rm $(docker ps -a -q)
                    docker run -d -p 80:3000 ${{ secrets.DOCKER_HUB_USERNAME }}/$IMAGE_NAME:${{ github.sha }}
                  EOF
